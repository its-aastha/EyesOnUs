<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard â€” EyesOnUS</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="canvas">
    <!-- HEADER -->
    <header class="header nav">
        <div>
            <h1>EyesOnUS</h1>
            <p class="subtitle">Dashboard</p>
        </div>
        <div style="display:flex; gap:12px; align-items:center;">
            <div style="color:#cbd5e1;">{{ session.get('user') }}</div>
            <a class="btn btn-outline" href="/profile">Profile</a>
            <a class="btn btn-outline" href="/logout">Log out</a>
        </div>
    </header>

    <div class="content">
        <!-- CAMERA CARD -->
        <div class="paper-card camera">
            <div class="tape"></div>
            <img id="cameraFeed" src="{{ url_for('video') }}" alt="Camera Feed">
            <p class="caption">Live Study Session</p>

            <!-- CONTROLS -->
            <div class="controls">
                <select id="timerSelect" class="timer-select">
                    <option value="5">5 second</option>
                    <option value="60">1 minute</option>
                    <option value="1500">25 minutes</option>
                    <option value="2700">45 minutes</option>
                    <option value="3600">60 minutes</option>
                    <option value="5400">1 hour 30 minutes</option>
                </select>

                <button id="startBtn" class="btn btn--success">Start session</button>
                <button id="stopBtn" class="btn btn--secondary" disabled>Stop session</button>
                <div id="sessionBadge" class="session-badge">Inactive</div>
            </div>

            <!-- STATS -->
            <div class="stats">
                <div class="stat">
                    <div>Focused</div>
                    <strong id="focused">00:00</strong>
                </div>
                <div class="stat">
                    <div>Distracted</div>
                    <strong id="distracted">00:00</strong>
                </div>
                <div class="stat">
                    <div>Score</div>
                    <strong id="score">0%</strong>
                </div>
            </div>
        </div>

        <!-- RIGHT CARD -->
        <div class="paper-card" style="max-height:520px;">
            <h3>Session notes</h3>

            <div id="lastSession" style="margin-top:12px;">
                <div class="placeholder">
                    <p>Press <strong>Start session</strong> to activate focus detection.</p>
                </div>
            </div>

            <!-- RECENT SESSIONS -->
            <div style="margin-top:18px;">
                <h4 style="color:#cbd5e1;">Recent sessions</h4>
                <div id="sessionList"
                     style="display:flex; flex-direction:column; gap:10px; max-height:160px; overflow:auto;">
                </div>
            </div>

            <!-- AUTO FOCUS CALENDAR -->
            <div style="margin-top:18px;">
                <h4 style="color:#cbd5e1;">Focus Calendar</h4>
                <div id="calendar" class="calendar-grid"></div>
            </div>
        </div>
    </div>

    <footer class="footer">Built with AI â€¢ OpenCV â€¢ Flask</footer>
</div>

<script>
/* ================= GLOBAL STATE ================= */
let countdownInterval = null;
let remainingSeconds = 0;
let sessionHistory = [];

/* ================= ELEMENTS ================= */
const timerSelect = document.getElementById('timerSelect');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const sessionBadge = document.getElementById('sessionBadge');
const sessionList = document.getElementById('sessionList');
const lastSessionEl = document.getElementById('lastSession');

/* ================= START SESSION ================= */
startBtn.addEventListener('click', async () => {
    remainingSeconds = parseInt(timerSelect.value);

    const res = await fetch('/session/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ duration: remainingSeconds })
    });

    if (res.ok) {
        startCountdown();
        updateStatus();
    }
});

/* ================= STOP SESSION ================= */
stopBtn.addEventListener('click', async () => {
    clearInterval(countdownInterval);
    sessionBadge.textContent = "Stopped";

    const res = await fetch('/session/stop', { method: 'POST' });
    if (res.ok) {
        const payload = await res.json();
        if (payload.last_session) {
            sessionHistory.push(payload.last_session);
            renderLastSession(payload.last_session, true);
            buildCalendar();
        }
        updateStatus();
    }
});

/* ================= COUNTDOWN ================= */
function startCountdown() {
    clearInterval(countdownInterval);

    countdownInterval = setInterval(async () => {
        remainingSeconds--;

        const m = Math.floor(remainingSeconds / 60);
        const s = String(remainingSeconds % 60).padStart(2, '0');

        sessionBadge.textContent = `Active â€¢ ${m}:${s}`;

        if (remainingSeconds <= 0) {
            clearInterval(countdownInterval);

            const res = await fetch('/session/stop', { method: 'POST' });
            if (res.ok) {
                const payload = await res.json();
                if (payload.last_session) {
                    sessionHistory.push(payload.last_session);
                    renderLastSession(payload.last_session, true);
                    buildCalendar();
                }
            }

            sessionBadge.textContent = "Completed âœ…";

            lastSessionEl.innerHTML = `
                <div class="congrats-box">
                    <h3>ðŸŽ‰ Congratulations!</h3>
                    <p>You completed your focus session.</p>
                </div>
            `;

            updateStatus();
        }
    }, 1000);
}

/* ================= STATUS UPDATE ================= */
async function updateStatus() {
    try {
        const res = await fetch('/api/status');
        if (!res.ok) return;

        const j = await res.json();

        document.getElementById('focused').textContent = formatTime(j.focused);
        document.getElementById('distracted').textContent = formatTime(j.unfocused);
        document.getElementById('score').textContent = j.score + "%";

        startBtn.disabled = j.session_active;
        stopBtn.disabled = !j.session_active;
    } catch {
        sessionBadge.textContent = "Disconnected";
    }
}

/* ================= RENDER SESSION ================= */
function renderLastSession(s, prepend = false) {
    lastSessionEl.innerHTML = `
        <div class="session-record">
            <div>Duration: ${formatTime(s.total_seconds)}</div>
            <div>Focused: ${formatTime(s.focused_seconds)}</div>
            <div>Distracted: ${formatTime(s.unfocused_seconds)}</div>
            <div>Score: ${s.score}%</div>
        </div>
    `;

    const item = document.createElement('div');
    item.className = 'session-list-item';
    item.innerHTML = `<strong>${s.score}%</strong> â€” ${s.start_str}`;

    if (prepend) sessionList.prepend(item);
    else sessionList.appendChild(item);
}

/* ================= FORMAT TIME ================= */
function formatTime(t) {
    const m = Math.floor(t / 60).toString().padStart(2, '0');
    const s = Math.floor(t % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
}

/* ================= AUTO CALENDAR ================= */
function buildCalendar() {
    const calendar = document.getElementById("calendar");
    calendar.innerHTML = "";

    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    const scoreMap = {};
    sessionHistory.forEach(s => {
        const date = s.start_str.split(" ")[0];
        scoreMap[date] = Math.max(scoreMap[date] || 0, s.score);
    });

    for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const div = document.createElement("div");
        div.className = "calendar-day";
        div.textContent = d;

        if (scoreMap[dateStr] >= 70) {
            div.classList.add("star");
        }

        calendar.appendChild(div);
    }
}

/* ================= AUTO REFRESH ================= */
setInterval(updateStatus, 1000);
updateStatus();
buildCalendar();
</script>

</body>
</html>
